import{a9 as v,g as $}from"./D0_loxAU.js";import{u as k}from"./CxRmHzWs.js";const P="multibox_active_account",M=()=>{const c=v("accounts",()=>[]),n=v("activeAccountId",()=>""),h=v("accounts-loading",()=>!1),u=v("adding-account",()=>!1),s=()=>{{const a=localStorage.getItem(P);a&&!n.value&&(n.value=a)}},d=a=>{localStorage.setItem(P,a)},m=async()=>{h.value=!0;try{const{authFetch:a}=k(),i=await a("/api/accounts");c.value=i.accounts,s(),!n.value&&i.activeAccountId&&(n.value=i.activeAccountId),n.value&&!c.value.find(b=>b.id===n.value)&&c.value.length>0&&(n.value=c.value[0].id,d(n.value)),!n.value&&c.value.length>0&&(n.value=c.value[0].id,d(n.value))}catch(a){console.error("Error fetching accounts:",a)}finally{h.value=!1}},x=async a=>{n.value=a,d(a),c.value=c.value.map(i=>({...i,isActive:i.id===a}));try{const{authFetch:i}=k();await i("/api/accounts/switch",{method:"POST",body:{accountId:a}})}catch(i){console.error("Error syncing account switch to DB:",i)}return!0},g=a=>`https://www.dropbox.com/oauth2/authorize?client_id=${a}&response_type=code&token_access_type=offline`,E=async(a,i,b,p)=>{var S,F;u.value=!0;try{const{authFetch:w}=k(),y=await w("/api/accounts/add",{method:"POST",body:{code:a,appKey:i,appSecret:b,name:p}});return y.success?(await m(),(S=y.account)!=null&&S.id&&(n.value=y.account.id,d(y.account.id)),{success:!0,account:y.account}):{success:!1,error:"Unknown error"}}catch(w){return console.error("Error adding account:",w),{success:!1,error:((F=w.data)==null?void 0:F.message)||w.message||"Failed to add account"}}finally{u.value=!1}},I=async a=>{try{const{authFetch:i}=k();return await i("/api/accounts/delete",{method:"POST",body:{accountId:a}}),c.value=c.value.filter(b=>b.id!==a),n.value===a&&c.value.length>0?(n.value=c.value[0].id,d(n.value)):c.value.length===0&&(n.value="",localStorage.removeItem(P)),!0}catch(i){return console.error("Error removing account:",i),!1}},A=$(()=>c.value.find(a=>a.id===n.value));return{accounts:c,activeAccountId:n,activeAccount:A,isLoading:h,isAddingAccount:u,fetchAccounts:m,switchAccount:x,getAuthUrl:g,addAccount:E,removeAccount:I}},R=c=>{const{activeAccountId:n}=M(),h=c?`-${c}`:"-main",u=$(()=>c||n.value),s=v(`dropbox-path${h}`,()=>""),d=v(`dropbox-files${h}`,()=>[]),m=v(`dropbox-loading${h}`,()=>!1),x=v(`dropbox-error${h}`,()=>null),g=v(`dropbox-selected${h}`,()=>new Set),E=$(()=>d.value.filter(e=>g.value.has(e.id))),I=e=>{const t=new Set(g.value);t.has(e)?t.delete(e):t.add(e),g.value=t},A=()=>{g.value=new Set(d.value.map(e=>e.id))},a=()=>{g.value=new Set},i=e=>g.value.has(e),b=$(()=>d.value.length>0&&g.value.size===d.value.length),p=async(e="",t=!1)=>{var o;if(m.value=!0,x.value=null,a(),!u.value){m.value=!1;return}t&&(d.value=[]);try{const r=await $fetch("/api/dropbox/files",{query:{path:e,accountId:u.value}});d.value=r.entries,s.value=e}catch(r){console.error("Error fetching files:",r),x.value=((o=r.data)==null?void 0:o.message)||r.message||"Failed to load files",d.value=[]}finally{m.value=!1}},S=e=>{p(e)},F=()=>{if(!s.value)return;const e=s.value.split("/");e.pop();const t=e.join("/");p(t)},w=async e=>{try{return(await $fetch("/api/dropbox/download",{query:{path:e,accountId:u.value}})).link}catch(t){return console.error("Error getting download link:",t),null}},y=async e=>{var t;try{return await $fetch("/api/dropbox/folder",{method:"POST",body:{path:s.value,name:e,accountId:u.value}}),await p(s.value),!0}catch(o){throw console.error("Error creating folder:",o),new Error(((t=o.data)==null?void 0:t.message)||"Failed to create folder")}},{authFetch:D}=k();return{currentPath:s,files:d,isLoading:m,error:x,selectedIds:g,selectedFiles:E,toggleSelect:I,selectAll:A,clearSelection:a,isSelected:i,isAllSelected:b,fetchFiles:p,navigateToFolder:S,navigateUp:F,getDownloadLink:w,createFolder:y,deleteItem:async e=>{var t;try{return await D("/api/dropbox/delete",{method:"POST",body:{path:e,accountId:u.value}}),await p(s.value),!0}catch(o){throw console.error("Error deleting:",o),new Error(((t=o.data)==null?void 0:t.message)||"Failed to delete")}},bulkDelete:async e=>{var t;try{return await $fetch("/api/dropbox/bulk-delete",{method:"POST",body:{paths:e,accountId:u.value}}),a(),await p(s.value),!0}catch(o){throw console.error("Error bulk deleting:",o),new Error(((t=o.data)==null?void 0:t.message)||"Failed to delete files")}},renameItem:async(e,t)=>{var o;try{const r=e.split("/");r.pop();const l=[...r,t].join("/");return await $fetch("/api/dropbox/move",{method:"POST",body:{fromPath:e,toPath:l,accountId:u.value}}),await p(s.value),!0}catch(r){throw console.error("Error renaming:",r),new Error(((o=r.data)==null?void 0:o.message)||"Failed to rename")}},bulkMove:async(e,t)=>{var o;try{const r=e.map(l=>{const f=l.split("/").pop(),T=t?`${t}/${f}`:`/${f}`;return{from_path:l,to_path:T}});return await $fetch("/api/dropbox/bulk-move",{method:"POST",body:{entries:r,accountId:u.value}}),a(),await p(s.value),!0}catch(r){throw console.error("Error bulk moving:",r),new Error(((o=r.data)==null?void 0:o.message)||"Failed to move files")}},bulkCopy:async(e,t)=>{var o;try{const r=e.map(l=>{const f=l.split("/").pop(),T=t?`${t}/${f}`:`/${f}`;return{from_path:l,to_path:T}});return await $fetch("/api/dropbox/bulk-copy",{method:"POST",body:{entries:r,accountId:u.value}}),a(),await p(s.value),!0}catch(r){throw console.error("Error bulk copying:",r),new Error(((o=r.data)==null?void 0:o.message)||"Failed to copy files")}},bulkDownload:async e=>{var t;try{const o=await $fetch("/api/dropbox/bulk-download",{method:"POST",body:{paths:e}});if(o.type==="single")window.open(o.link,"_blank");else for(const r of o.links)if(r!=null&&r.link){const l=document.createElement("a");l.href=r.link,l.download=r.name,l.target="_blank",document.body.appendChild(l),l.click(),document.body.removeChild(l),await new Promise(f=>setTimeout(f,500))}a()}catch(o){throw console.error("Error bulk downloading:",o),new Error(((t=o.data)==null?void 0:t.message)||"Failed to download files")}},uploadFiles:async e=>{try{const t=await $fetch("/api/dropbox/upload-session",{query:{path:s.value,accountId:u.value}});for(const o of Array.from(e)){const r=s.value?`${s.value}/${o.name}`:`/${o.name}`,l=await fetch("https://content.dropboxapi.com/2/files/upload",{method:"POST",headers:{Authorization:`Bearer ${t.accessToken}`,"Dropbox-API-Arg":JSON.stringify({path:r,mode:"add",autorename:!0,mute:!1}),"Content-Type":"application/octet-stream"},body:o});if(!l.ok){const f=await l.json();throw new Error(f.error_summary||`Failed to upload ${o.name}`)}try{await D("/api/dropbox/record-upload",{method:"POST",body:{filename:o.name,dropboxPath:r,size:o.size,contentType:o.type,dropboxAccountId:t.accountId||u.value}})}catch(f){console.error("Failed to record upload in DB:",f)}}return await p(s.value),!0}catch(t){throw console.error("Error uploading:",t),new Error(t.message||"Failed to upload files")}},formatFileSize:e=>{if(e===null)return"-";if(e===0)return"0 B";const t=1024,o=["B","KB","MB","GB","TB"],r=Math.floor(Math.log(e)/Math.log(t));return parseFloat((e/Math.pow(t,r)).toFixed(1))+" "+o[r]},formatDate:e=>{if(!e)return"-";const t=new Date(e),r=new Date().getTime()-t.getTime(),l=Math.floor(r/(1e3*60*60*24));return l===0?"Today":l===1?"Yesterday":l<7?`${l} days ago`:l<30?`${Math.floor(l/7)} weeks ago`:t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})},getFileIcon:e=>{if(e.type==="folder")return"lucide:folder";const t=e.extension;return{pdf:"lucide:file-text",doc:"lucide:file-text",docx:"lucide:file-text",txt:"lucide:file-text",xls:"lucide:file-spreadsheet",xlsx:"lucide:file-spreadsheet",csv:"lucide:file-spreadsheet",ppt:"lucide:presentation",pptx:"lucide:presentation",jpg:"lucide:image",jpeg:"lucide:image",png:"lucide:image",gif:"lucide:image",svg:"lucide:image",webp:"lucide:image",mp4:"lucide:file-video",mov:"lucide:file-video",avi:"lucide:file-video",mkv:"lucide:file-video",mp3:"lucide:file-audio",wav:"lucide:file-audio",flac:"lucide:file-audio",zip:"lucide:file-archive",rar:"lucide:file-archive","7z":"lucide:file-archive",tar:"lucide:file-archive",gz:"lucide:file-archive",js:"lucide:file-code",ts:"lucide:file-code",py:"lucide:file-code",html:"lucide:file-code",css:"lucide:file-code",json:"lucide:file-json"}[t||""]||"lucide:file"},getIconColor:e=>{if(e.type==="folder")return"text-yellow-600 bg-yellow-50 dark:bg-yellow-900/30";const t=e.extension;return{pdf:"text-red-600 bg-red-50 dark:bg-red-900/30",doc:"text-blue-600 bg-blue-50 dark:bg-blue-900/30",docx:"text-blue-600 bg-blue-50 dark:bg-blue-900/30",xls:"text-green-600 bg-green-50 dark:bg-green-900/30",xlsx:"text-green-600 bg-green-50 dark:bg-green-900/30",ppt:"text-orange-600 bg-orange-50 dark:bg-orange-900/30",pptx:"text-orange-600 bg-orange-50 dark:bg-orange-900/30",jpg:"text-purple-600 bg-purple-50 dark:bg-purple-900/30",jpeg:"text-purple-600 bg-purple-50 dark:bg-purple-900/30",png:"text-purple-600 bg-purple-50 dark:bg-purple-900/30",mp4:"text-pink-600 bg-pink-50 dark:bg-pink-900/30",mp3:"text-indigo-600 bg-indigo-50 dark:bg-indigo-900/30",zip:"text-amber-600 bg-amber-50 dark:bg-amber-900/30"}[t||""]||"text-gray-600 bg-gray-50 dark:bg-gray-900/30"},getFolders:async(e="")=>{try{return(await $fetch("/api/dropbox/files",{query:{path:e,accountId:u.value}})).entries.filter(o=>o.type==="folder")}catch(t){return console.error("Error fetching folders:",t),[]}}}};export{R as a,M as u};
